name: Lifetime Bot Automation - Dieter_v2

on:
  workflow_dispatch: {}

  schedule:
    # 9:30â€“9:55 AM CST (UTC 15:30â€“15:55)
    # Booking days: Sun, Mon, Wed, Thu
    - cron: '30-59/5 15 * * 0,1,3,4'

    # 10:00â€“10:05 AM CST (UTC 16:00â€“16:05)
    # Booking days: Sun, Mon, Wed, Thu
    - cron: '0-5/5 16 * * 0,1,3,4'

concurrency:
  group: lifetime-bot
  cancel-in-progress: true

jobs:
  run-bot:
    runs-on: ubuntu-latest
    timeout-minutes: 25

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Set up Chrome
        uses: browser-actions/setup-chrome@v1

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Write .env from secrets + constants
        run: |
          TARGET_DATE=$(date -u -d "+8 days" +"%Y-%m-%d")
          echo "Using TARGET_DATE=$TARGET_DATE"

          cat > .env <<EOF
          # ðŸ” Credentials (secrets)
          LIFETIME_USERNAME=${{ secrets.LIFETIME_USERNAME }}
          LIFETIME_PASSWORD=${{ secrets.LIFETIME_PASSWORD }}

          # ðŸ‹ï¸ Constants
          LIFETIME_CLUB_NAME=San Antonio 281
          LIFETIME_CLUB_STATE=TX
          TARGET_INSTRUCTOR=Zack W
          TARGET_CLASS=Alpha
          START_TIME=8:00 AM
          END_TIME=9:00 AM
          WHO_AM_I=Dieter
          HEADLESS=Yes
          RUN_ON_SCHEDULE=Yes
          NOTIFICATION_METHOD=Telegram

          # ðŸ“… Booking logic
          TARGET_DATE=$TARGET_DATE

          # ðŸ”” Notifications
          EMAIL_SENDER=${{ secrets.EMAIL_SENDER }}
          EMAIL_PASSWORD=${{ secrets.EMAIL_PASSWORD }}
          EMAIL_RECEIVER=${{ secrets.EMAIL_RECEIVER }}
          SMTP_SERVER=${{ secrets.SMTP_SERVER }}
          SMTP_PORT=${{ secrets.SMTP_PORT }}

          SMS_NUMBER=${{ secrets.SMS_NUMBER }}
          SMS_CARRIER=${{ secrets.SMS_CARRIER }}

          TELEGRAM_TOKEN=${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID=${{ secrets.TELEGRAM_CHAT_ID }}
          EOF

          chmod 600 .env

      - name: Run Lifetime reservation bot
        run: |
          python lifetime_bot_v2.py
