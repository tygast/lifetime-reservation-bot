name: Lifetime Bot Automation - Dieter

on:
  # Allow manual runs
  workflow_dispatch: {}

  # Scheduled runs (UTC)
  schedule:
    # 9:30–9:55 AM CST (UTC 15:30–15:55), every 5 minutes, Sun–Thu
    - cron: '30-59/5 15 * * 0-4'

    # 10:00–10:05 AM CST (UTC 16:00–16:05), every 5 minutes, Sun–Thu
    - cron: '0-5/5 16 * * 0-4'

# Prevent overlapping runs during retry window
concurrency:
  group: lifetime-bot
  cancel-in-progress: true

jobs:
  run-bot:
    runs-on: ubuntu-latest
    timeout-minutes: 25

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Set up Chrome (and ChromeDriver)
        uses: browser-actions/setup-chrome@v1

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Write .env from secrets (dynamic +8 day target date)
        run: |
          # Target date = today + 8 days
          TARGET_DATE=$(date -u -d "+8 days" +"%Y-%m-%d")
          echo "Using TARGET_DATE=$TARGET_DATE"

          cat > .env <<EOF
          LIFETIME_USERNAME=${{ secrets.LIFETIME_USERNAME }}
          LIFETIME_PASSWORD=${{ secrets.LIFETIME_PASSWORD }}
          LIFETIME_CLUB_NAME=${{ secrets.LIFETIME_CLUB_NAME }}
          LIFETIME_CLUB_STATE=${{ secrets.LIFETIME_CLUB_STATE }}

          TARGET_CLASS=${{ secrets.TARGET_CLASS }}
          TARGET_INSTRUCTOR=${{ secrets.TARGET_INSTRUCTOR }}
          TARGET_DATE=$TARGET_DATE
          START_TIME=${{ secrets.START_TIME }}
          END_TIME=${{ secrets.END_TIME }}

          NOTIFICATION_METHOD=${{ secrets.NOTIFICATION_METHOD }}

          EMAIL_SENDER=${{ secrets.EMAIL_SENDER }}
          EMAIL_PASSWORD=${{ secrets.EMAIL_PASSWORD }}
          EMAIL_RECEIVER=${{ secrets.EMAIL_RECEIVER }}
          SMTP_SERVER=${{ secrets.SMTP_SERVER }}
          SMTP_PORT=${{ secrets.SMTP_PORT }}

          SMS_NUMBER=${{ secrets.SMS_NUMBER }}
          SMS_CARRIER=${{ secrets.SMS_CARRIER }}

          HEADLESS=${{ secrets.HEADLESS }}
          RUN_ON_SCHEDULE=${{ secrets.RUN_ON_SCHEDULE }}
          EOF

          chmod 600 .env

      - name: Run Lifetime reservation bot
        run: |
          python lifetime_bot.py
