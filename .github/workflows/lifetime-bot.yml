name: Lifetime Bot Automation

on:
  workflow_dispatch: {}
  schedule:
    # GitHub cron runs in UTC (adjust for America/Chicago + DST)
    - cron: "0 3 * * *"  # example only

concurrency:
  group: lifetime-bot
  cancel-in-progress: true

jobs:
  run-bot:
    runs-on: ubuntu-latest
    timeout-minutes: 25

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # Ensures Chrome + matching ChromeDriver (Selenium) are available
      - name: Set up Chrome (and ChromeDriver)
        uses: browser-actions/setup-chrome@v1

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # Create a .env file exactly like the README expects
      - name: Write .env from secrets
        run: |
          cat > .env <<EOF
          LIFETIME_USERNAME=${{ secrets.LIFETIME_USERNAME }}
          LIFETIME_PASSWORD=${{ secrets.LIFETIME_PASSWORD }}
          LIFETIME_CLUB_NAME=${{ secrets.LIFETIME_CLUB_NAME }}
          LIFETIME_CLUB_STATE=${{ secrets.LIFETIME_CLUB_STATE }}

          TARGET_CLASS=${{ secrets.TARGET_CLASS }}
          TARGET_INSTRUCTOR=${{ secrets.TARGET_INSTRUCTOR }}
          TARGET_DATE=${{ secrets.TARGET_DATE }}
          START_TIME=${{ secrets.START_TIME }}
          END_TIME=${{ secrets.END_TIME }}

          NOTIFICATION_METHOD=${{ secrets.NOTIFICATION_METHOD }}

          EMAIL_SENDER=${{ secrets.EMAIL_SENDER }}
          EMAIL_PASSWORD=${{ secrets.EMAIL_PASSWORD }}
          EMAIL_RECEIVER=${{ secrets.EMAIL_RECEIVER }}
          SMTP_SERVER=${{ secrets.SMTP_SERVER }}
          SMTP_PORT=${{ secrets.SMTP_PORT }}

          SMS_NUMBER=${{ secrets.SMS_NUMBER }}
          SMS_CARRIER=${{ secrets.SMS_CARRIER }}

          HEADLESS=${{ secrets.HEADLESS }}
          RUN_ON_SCHEDULE=${{ secrets.RUN_ON_SCHEDULE }}
          EOF
          chmod 600 .env

      - name: Run bot
        run: |
          python lifetime_bot.py
